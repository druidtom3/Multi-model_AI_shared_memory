{% extends "base.html" %}

{% block title %}éŒ¯èª¤ - å¤šAIå”ä½œé–‹ç™¼å¹³å°{% endblock %}

{% block content %}
<div class="card" style="text-align: center;">
    <h2 style="color: #e74c3c;">
        {% if error_code %}
            éŒ¯èª¤ {{ error_code }}
        {% else %}
            ç³»çµ±éŒ¯èª¤
        {% endif %}
    </h2>
    
    <div style="font-size: 4rem; margin: 2rem 0; opacity: 0.3;">
        {% if error_code == 404 %}
            ğŸ”
        {% elif error_code == 500 %}
            âš ï¸
        {% else %}
            âŒ
        {% endif %}
    </div>
    
    <div class="alert alert-error" style="text-align: left; margin: 2rem 0;">
        <h3>éŒ¯èª¤è©³æƒ…</h3>
        <p>{{ error }}</p>
        
        {% if error_code == 404 %}
        <p><strong>å¯èƒ½åŸå› ï¼š</strong></p>
        <ul>
            <li>ç¶²å€è¼¸å…¥éŒ¯èª¤</li>
            <li>é é¢å·²è¢«ç§»å‹•æˆ–åˆªé™¤</li>
            <li>æ¬Šé™ä¸è¶³</li>
        </ul>
        {% elif error_code == 500 %}
        <p><strong>å¯èƒ½åŸå› ï¼š</strong></p>
        <ul>
            <li>ç³»çµ±é…ç½®å•é¡Œ</li>
            <li>APIé‡‘é‘°æœªè¨­ç½®æˆ–ç„¡æ•ˆ</li>
            <li>è³‡æ–™åº«é€£æ¥å•é¡Œ</li>
            <li>æª”æ¡ˆæ¬Šé™å•é¡Œ</li>
        </ul>
        {% endif %}
    </div>
    
    <div style="margin-top: 2rem;">
        <h3>è§£æ±ºå»ºè­°</h3>
        
        {% if error_code == 404 %}
        <p>è«‹æª¢æŸ¥ç¶²å€æ˜¯å¦æ­£ç¢ºï¼Œæˆ–ä½¿ç”¨å°èˆªé¸å–®è¿”å›æœ‰æ•ˆé é¢ã€‚</p>
        {% elif error_code == 500 %}
        <div class="alert alert-info" style="text-align: left;">
            <h4>æª¢æŸ¥æ¸…å–®</h4>
            <ol>
                <li><strong>APIé‡‘é‘°è¨­ç½®ï¼š</strong> ç¢ºèª .env æª”æ¡ˆä¸­çš„APIé‡‘é‘°å·²æ­£ç¢ºè¨­ç½®</li>
                <li><strong>æª”æ¡ˆæ¬Šé™ï¼š</strong> ç¢ºèª data/ å’Œ workspace/ ç›®éŒ„å…·æœ‰è®€å¯«æ¬Šé™</li>
                <li><strong>ä¾è³´å¥—ä»¶ï¼š</strong> ç¢ºèªå·²å®‰è£æ‰€æœ‰å¿…è¦çš„Pythonå¥—ä»¶</li>
                <li><strong>ç¶²è·¯é€£æ¥ï¼š</strong> ç¢ºèªå¯ä»¥æ­£å¸¸è¨ªå•AIæœå‹™æä¾›å•†çš„API</li>
            </ol>
        </div>
        {% else %}
        <p>è«‹å˜—è©¦é‡æ–°è¼‰å…¥é é¢ï¼Œå¦‚æœå•é¡ŒæŒçºŒå­˜åœ¨ï¼Œè«‹è¯ç¹«ç³»çµ±ç®¡ç†å“¡ã€‚</p>
        {% endif %}
    </div>
    
    <div style="margin-top: 2rem; display: flex; gap: 1rem; justify-content: center;">
        <a href="{{ url_for('index') }}" class="btn btn-primary">è¿”å›ä¸»é </a>
        <button onclick="history.back()" class="btn btn-warning">è¿”å›ä¸Šä¸€é </button>
        <button onclick="location.reload()" class="btn btn-success">é‡æ–°è¼‰å…¥</button>
    </div>
    
    {% if error_code == 500 %}
    <div style="margin-top: 2rem;">
        <details style="text-align: left; background-color: #f8f9fa; padding: 1rem; border-radius: 4px;">
            <summary style="cursor: pointer; font-weight: bold;">æŠ€è¡“è³‡è¨Š (é»æ“Šå±•é–‹)</summary>
            <div style="margin-top: 1rem; font-family: monospace; font-size: 0.9rem;">
                <p><strong>æ™‚é–“æˆ³ï¼š</strong> {{ moment().format('YYYY-MM-DD HH:mm:ss') }}</p>
                <p><strong>è«‹æ±‚è·¯å¾‘ï¼š</strong> {{ request.path }}</p>
                <p><strong>è«‹æ±‚æ–¹æ³•ï¼š</strong> {{ request.method }}</p>
                <p><strong>ä½¿ç”¨è€…ä»£ç†ï¼š</strong> {{ request.headers.get('User-Agent', 'Unknown') }}</p>
                <p><strong>éŒ¯èª¤è¨Šæ¯ï¼š</strong> {{ error }}</p>
            </div>
        </details>
    </div>
    {% endif %}
</div>

<!-- ç³»çµ±å¥åº·æª¢æŸ¥ -->
{% if error_code == 500 %}
<div class="card">
    <h3>ç³»çµ±ç‹€æ…‹æª¢æŸ¥</h3>
    <div id="health-check">
        <p>æ­£åœ¨æª¢æŸ¥ç³»çµ±ç‹€æ…‹...</p>
        <div class="loading"></div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_scripts %}
{% if error_code == 500 %}
<script>
    // åŸ·è¡Œç³»çµ±å¥åº·æª¢æŸ¥
    document.addEventListener('DOMContentLoaded', async function() {
        const healthCheckDiv = document.getElementById('health-check');
        
        if (!healthCheckDiv) return;
        
        try {
            const response = await fetch('/api/project-status');
            
            if (response.ok) {
                const data = await response.json();
                
                if (data.success) {
                    healthCheckDiv.innerHTML = `
                        <div class="alert alert-success">
                            <h4>ç³»çµ±åŸºæœ¬åŠŸèƒ½æ­£å¸¸</h4>
                            <p>æ ¸å¿ƒæœå‹™æ­£åœ¨é‹è¡Œï¼ŒéŒ¯èª¤å¯èƒ½æ˜¯æš«æ™‚æ€§çš„ã€‚</p>
                        </div>
                        <details style="margin-top: 1rem;">
                            <summary>è©³ç´°ç‹€æ…‹</summary>
                            <pre style="background-color: #f8f9fa; padding: 1rem; border-radius: 4px; margin-top: 1rem; overflow: auto;">${JSON.stringify(data.status, null, 2)}</pre>
                        </details>
                    `;
                } else {
                    healthCheckDiv.innerHTML = `
                        <div class="alert alert-error">
                            <h4>ç³»çµ±ç‹€æ…‹ç•°å¸¸</h4>
                            <p>æª¢æ¸¬åˆ°ç³»çµ±å•é¡Œï¼š${data.error}</p>
                        </div>
                    `;
                }
            } else {
                throw new Error(`HTTP ${response.status}`);
            }
        } catch (error) {
            healthCheckDiv.innerHTML = `
                <div class="alert alert-error">
                    <h4>ç„¡æ³•é€£æ¥åˆ°ç³»çµ±æ ¸å¿ƒ</h4>
                    <p>ç³»çµ±æ ¸å¿ƒæœå‹™å¯èƒ½æœªå•Ÿå‹•æˆ–é…ç½®æœ‰èª¤ã€‚</p>
                    <p><strong>æŠ€è¡“è©³æƒ…ï¼š</strong> ${error.message}</p>
                </div>
                <div class="alert alert-info" style="margin-top: 1rem;">
                    <h4>å»ºè­°è™•ç†æ­¥é©Ÿ</h4>
                    <ol>
                        <li>æª¢æŸ¥ .env æª”æ¡ˆä¸­çš„è¨­å®š</li>
                        <li>ç¢ºèªæ‰€æœ‰ä¾è³´å¥—ä»¶å·²å®‰è£ï¼š<code>pip install -r requirements.txt</code></li>
                        <li>æª¢æŸ¥ data/ ç›®éŒ„æ˜¯å¦å­˜åœ¨ä¸”æœ‰å¯«å…¥æ¬Šé™</li>
                        <li>é‡æ–°å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼</li>
                    </ol>
                </div>
            `;
        }
    });
</script>
{% endif %}

<!-- éŒ¯èª¤å›å ±åŠŸèƒ½ -->
<script>
    function reportError() {
        const errorDetails = {
            error: "{{ error }}",
            error_code: {{ error_code or 'null' }},
            timestamp: new Date().toISOString(),
            url: window.location.href,
            user_agent: navigator.userAgent
        };
        
        // é€™è£¡å¯ä»¥å¯¦ä½œéŒ¯èª¤å›å ±åŠŸèƒ½
        console.log('éŒ¯èª¤è©³æƒ…:', errorDetails);
        
        // è¤‡è£½éŒ¯èª¤è³‡è¨Šåˆ°å‰ªè²¼ç°¿
        if (navigator.clipboard) {
            navigator.clipboard.writeText(JSON.stringify(errorDetails, null, 2))
                .then(() => showAlert('éŒ¯èª¤è³‡è¨Šå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿', 'success'))
                .catch(() => showAlert('è¤‡è£½å¤±æ•—', 'error'));
        }
    }
</script>

<style>
    .alert h4 {
        margin-bottom: 0.5rem;
    }
    
    .alert ol, .alert ul {
        margin-left: 1.5rem;
        margin-top: 0.5rem;
    }
    
    .alert li {
        margin-bottom: 0.25rem;
    }
    
    code {
        background-color: #f1f3f4;
        padding: 0.2rem 0.4rem;
        border-radius: 3px;
        font-family: monospace;
    }
    
    details summary {
        margin-bottom: 0.5rem;
    }
    
    details[open] summary {
        margin-bottom: 1rem;
    }
</style>
{% endblock %}