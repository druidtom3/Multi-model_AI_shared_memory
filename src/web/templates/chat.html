{% extends "base.html" %}

{% block title %}AIèŠå¤© - å¤šAIå”ä½œé–‹ç™¼å¹³å°{% endblock %}

{% block content %}
<div class="grid grid-2">
    <!-- AIé…ç½®é¢æ¿ -->
    <div class="card">
        <h2>AIé…ç½®</h2>
        
        <form id="ai-config-form">
            <div class="form-group">
                <label for="provider">AIä¾›æ‡‰å•†</label>
                <select id="provider" name="provider" onchange="updateModels()">
                    {% for provider_key, provider_data in available_providers.items() %}
                    <option value="{{ provider_key }}" 
                            {% if current_config.provider == provider_key %}selected{% endif %}>
                        {{ provider_data.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-group">
                <label for="model">æ¨¡å‹</label>
                <select id="model" name="model">
                    <!-- å‹•æ…‹æ›´æ–° -->
                </select>
            </div>
            
            <div class="form-group">
                <label for="role">å°ˆæ¥­è§’è‰²</label>
                <select id="role" name="role" onchange="updateRoleInfo()">
                    <optgroup label="ç¨‹å¼é–‹ç™¼è§’è‰²">
                        {% for role_key, role_data in available_roles.programming.items() %}
                        <option value="{{ role_key }}" 
                                data-type="programming"
                                {% if current_config.role == role_key %}selected{% endif %}>
                            {{ role_data.title }}
                        </option>
                        {% endfor %}
                    </optgroup>
                    <optgroup label="ä¸€èˆ¬åŠ©ç†è§’è‰²">
                        {% for role_key, role_data in available_roles.non_programming.items() %}
                        <option value="{{ role_key }}" 
                                data-type="non_programming"
                                {% if current_config.role == role_key %}selected{% endif %}>
                            {{ role_data.title }}
                        </option>
                        {% endfor %}
                    </optgroup>
                </select>
            </div>
            
            <div class="form-group">
                <label for="custom-role">è‡ªè¨‚è§’è‰²è¦æ±‚ (å¯é¸)</label>
                <textarea id="custom-role" name="custom_role" placeholder="åœ¨æ­¤è¼¸å…¥ç‰¹æ®Šçš„è§’è‰²è¦æ±‚æˆ–æŒ‡ç¤º..."></textarea>
            </div>
            
            <button type="button" class="btn btn-success" onclick="switchAI()">åˆ‡æ›AIé…ç½®</button>
        </form>
        
        <!-- è§’è‰²è³‡è¨Šé¡¯ç¤º -->
        <div id="role-info" class="card" style="margin-top: 1rem; background-color: #f8f9fa;">
            <h4>è§’è‰²è³‡è¨Š</h4>
            <div id="role-details">
                <!-- å‹•æ…‹æ›´æ–° -->
            </div>
        </div>
    </div>
    
    <!-- å°è©±é¢æ¿ -->
    <div class="card">
        <h2>AIå°è©±</h2>
        
        <div id="current-ai-display" class="alert alert-info">
            <strong>ç•¶å‰AI:</strong>
            <span id="current-ai-text">
                {{ current_config.provider }}/{{ current_config.model }}/{{ current_config.role }}
            </span>
        </div>
        
        <div id="chat-messages" style="height: 400px; overflow-y: auto; border: 1px solid #ddd; padding: 1rem; margin-bottom: 1rem; background-color: white;">
            <div class="chat-message system">
                <strong>ç³»çµ±:</strong> æ­¡è¿ä½¿ç”¨å¤šAIå”ä½œé–‹ç™¼å¹³å°ï¼è«‹é¸æ“‡é©åˆçš„AIé…ç½®ä¸¦é–‹å§‹å°è©±ã€‚
            </div>
        </div>
        
        <form id="chat-form">
            <div class="form-group">
                <label for="message">è¨Šæ¯</label>
                <textarea id="message" name="message" placeholder="è«‹è¼¸å…¥æ‚¨çš„å•é¡Œæˆ–ä»»å‹™æè¿°..." required></textarea>
            </div>
            
            <div style="display: flex; gap: 1rem; align-items: center;">
                <button type="submit" class="btn btn-primary" id="send-button">ç™¼é€è¨Šæ¯</button>
                <button type="button" class="btn btn-warning" onclick="clearChat()">æ¸…é™¤å°è©±</button>
            </div>
        </form>
    </div>
</div>

<!-- LinusåŸå‰‡æé†’ (åƒ…ç¨‹å¼é¡è§’è‰²é¡¯ç¤º) -->
<div id="linus-reminder" class="card" style="background-color: #fff3cd;">
    <h3>ğŸ”§ Linuså·¥ç¨‹å“²å­¸æé†’</h3>
    <ul>
        <li><strong>å¥½å“å‘³:</strong> è®“ç‰¹æ®Šæƒ…æ³æ¶ˆå¤±ï¼Œçµ±ä¸€è™•ç†æ–¹å¼</li>
        <li><strong>ç°¡æ½”æ€§:</strong> é¿å…ä¸å¿…è¦çš„è¤‡é›œåº¦ï¼Œç¸®æ’ä¸è¶…é3å±¤</li>
        <li><strong>å¯¦ç”¨ä¸»ç¾©:</strong> è§£æ±ºçœŸå¯¦å•é¡Œï¼Œé¿å…éåº¦è¨­è¨ˆ</li>
        <li><strong>Never break userspace:</strong> ä¿æŒå‘å¾Œç›¸å®¹æ€§</li>
    </ul>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // å…¨å±€è®Šæ•¸
    let availableProviders = {{ available_providers|tojson }};
    let availableRoles = {{ available_roles|tojson }};
    let currentConfig = {{ current_config|tojson }};
    
    // åˆå§‹åŒ–é é¢
    document.addEventListener('DOMContentLoaded', function() {
        updateModels();
        updateRoleInfo();
        
        // èŠå¤©è¡¨å–®æäº¤äº‹ä»¶
        document.getElementById('chat-form').addEventListener('submit', function(e) {
            e.preventDefault();
            sendMessage();
        });
    });
    
    // æ›´æ–°å¯ç”¨æ¨¡å‹
    function updateModels() {
        const provider = document.getElementById('provider').value;
        const modelSelect = document.getElementById('model');
        
        modelSelect.innerHTML = '';
        
        if (availableProviders[provider] && availableProviders[provider].models) {
            const models = availableProviders[provider].models;
            for (const [modelKey, modelData] of Object.entries(models)) {
                const option = document.createElement('option');
                option.value = modelKey;
                option.textContent = modelData.name;
                option.selected = (modelKey === currentConfig.model);
                modelSelect.appendChild(option);
            }
        }
    }
    
    // æ›´æ–°è§’è‰²è³‡è¨Š
    function updateRoleInfo() {
        const roleSelect = document.getElementById('role');
        const selectedRole = roleSelect.value;
        const roleType = roleSelect.options[roleSelect.selectedIndex].dataset.type;
        const roleDetails = document.getElementById('role-details');
        const linusReminder = document.getElementById('linus-reminder');
        
        let roleData = null;
        if (roleType === 'programming' && availableRoles.programming[selectedRole]) {
            roleData = availableRoles.programming[selectedRole];
            linusReminder.style.display = 'block';
        } else if (roleType === 'non_programming' && availableRoles.non_programming[selectedRole]) {
            roleData = availableRoles.non_programming[selectedRole];
            linusReminder.style.display = 'none';
        }
        
        if (roleData) {
            roleDetails.innerHTML = `
                <p><strong>å°ˆé•·é ˜åŸŸ:</strong> ${roleData.specialties.join(', ')}</p>
                ${roleData.linus_focus ? `<p><strong>LinusåŸå‰‡é‡é»:</strong> ${roleData.linus_focus}</p>` : ''}
                ${roleData.typical_tasks ? `<p><strong>å…¸å‹ä»»å‹™:</strong> ${roleData.typical_tasks.join(', ')}</p>` : ''}
            `;
        }
    }
    
    // åˆ‡æ›AIé…ç½®
    async function switchAI() {
        const form = document.getElementById('ai-config-form');
        const formData = new FormData(form);
        
        const newConfig = {
            provider: formData.get('provider'),
            model: formData.get('model'),
            role: formData.get('role')
        };
        
        const customRole = formData.get('custom_role');
        const handoverContext = customRole ? `è‡ªè¨‚è¦æ±‚: ${customRole}` : null;
        
        try {
            const result = await apiCall('/api/switch-ai', {
                method: 'POST',
                body: JSON.stringify({
                    ai_config: newConfig,
                    handover_context: handoverContext
                })
            });
            
            currentConfig = newConfig;
            
            // æ›´æ–°é¡¯ç¤º
            document.getElementById('current-ai-text').textContent = 
                `${newConfig.provider}/${newConfig.model}/${newConfig.role}`;
            
            // æ·»åŠ ç³»çµ±è¨Šæ¯
            addChatMessage('system', `å·²åˆ‡æ›åˆ° ${newConfig.provider}/${newConfig.role}`);
            
            showAlert('AIé…ç½®åˆ‡æ›æˆåŠŸï¼', 'success');
            
        } catch (error) {
            showAlert(`åˆ‡æ›å¤±æ•—: ${error.message}`, 'error');
        }
    }
    
    // ç™¼é€è¨Šæ¯
    async function sendMessage() {
        const messageInput = document.getElementById('message');
        const message = messageInput.value.trim();
        const sendButton = document.getElementById('send-button');
        
        if (!message) return;
        
        // æ·»åŠ ä½¿ç”¨è€…è¨Šæ¯åˆ°èŠå¤©æ¡†
        addChatMessage('user', message);
        messageInput.value = '';
        
        // è¨­ç½®è¼‰å…¥ç‹€æ…‹
        sendButton.dataset.originalText = sendButton.innerHTML;
        setLoading(sendButton);
        
        try {
            const customRole = document.getElementById('custom-role').value.trim();
            
            const result = await apiCall('/api/chat', {
                method: 'POST',
                body: JSON.stringify({
                    message: message,
                    ai_config: currentConfig,
                    custom_role: customRole || null
                })
            });
            
            // æ·»åŠ AIå›æ‡‰åˆ°èŠå¤©æ¡†
            addChatMessage('ai', result.result.ai_response, currentConfig);
            
            // å¦‚æœæœ‰å·¥ä½œå ±å‘Šï¼Œé¡¯ç¤ºæ‘˜è¦
            if (result.result.work_report) {
                addWorkReportSummary(result.result.work_report);
            }
            
            // å¦‚æœæœ‰LinusåŸå‰‡åˆè¦æ€§æª¢æŸ¥ï¼Œé¡¯ç¤ºçµæœ
            if (result.result.linus_compliance) {
                addLinusComplianceResult(result.result.linus_compliance);
            }
            
        } catch (error) {
            addChatMessage('system', `éŒ¯èª¤: ${error.message}`, null, 'error');
        } finally {
            setLoading(sendButton, false);
        }
    }
    
    // æ·»åŠ èŠå¤©è¨Šæ¯
    function addChatMessage(sender, content, aiConfig = null, type = 'normal') {
        const chatMessages = document.getElementById('chat-messages');
        const messageDiv = document.createElement('div');
        messageDiv.className = `chat-message ${sender} ${type}`;
        
        let senderLabel = sender;
        if (sender === 'ai' && aiConfig) {
            senderLabel = `${aiConfig.provider}/${aiConfig.role}`;
        } else if (sender === 'user') {
            senderLabel = 'æ‚¨';
        } else if (sender === 'system') {
            senderLabel = 'ç³»çµ±';
        }
        
        messageDiv.innerHTML = `
            <div style="margin-bottom: 0.5rem;">
                <strong>${senderLabel}:</strong>
                <small style="color: #666; margin-left: 1rem;">${formatTimestamp(new Date().toISOString())}</small>
            </div>
            <div style="white-space: pre-wrap;">${content}</div>
        `;
        
        // è¨­ç½®æ¨£å¼
        if (sender === 'user') {
            messageDiv.style.backgroundColor = '#e3f2fd';
        } else if (sender === 'ai') {
            messageDiv.style.backgroundColor = '#f1f8e9';
        } else if (sender === 'system' && type === 'error') {
            messageDiv.style.backgroundColor = '#ffebee';
        }
        
        messageDiv.style.padding = '1rem';
        messageDiv.style.margin = '0.5rem 0';
        messageDiv.style.borderRadius = '4px';
        messageDiv.style.borderLeft = '4px solid #2196f3';
        
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    // æ·»åŠ å·¥ä½œå ±å‘Šæ‘˜è¦
    function addWorkReportSummary(workReport) {
        const chatMessages = document.getElementById('chat-messages');
        const reportDiv = document.createElement('div');
        reportDiv.className = 'work-report-summary';
        reportDiv.style.backgroundColor = '#fff3e0';
        reportDiv.style.border = '1px solid #ffb74d';
        reportDiv.style.borderRadius = '4px';
        reportDiv.style.padding = '1rem';
        reportDiv.style.margin = '0.5rem 0';
        
        reportDiv.innerHTML = `
            <h4 style="margin: 0 0 0.5rem 0; color: #f57c00;">ğŸ“‹ å·¥ä½œå ±å‘Šæ‘˜è¦</h4>
            <p><strong>ä»»å‹™é¡å‹:</strong> ${workReport.task_type || 'æœªåˆ†é¡'}</p>
            <p><strong>æå–æ–¹æ³•:</strong> ${workReport.extraction_method || 'æœªçŸ¥'}</p>
            <p><strong>ä¿¡å¿ƒåº¦:</strong> ${workReport.confidence || 'æœªçŸ¥'}</p>
            ${workReport.summary ? `<p><strong>æ‘˜è¦:</strong> ${workReport.summary}</p>` : ''}
        `;
        
        chatMessages.appendChild(reportDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    // æ·»åŠ LinusåŸå‰‡åˆè¦æ€§çµæœ
    function addLinusComplianceResult(compliance) {
        const chatMessages = document.getElementById('chat-messages');
        const complianceDiv = document.createElement('div');
        complianceDiv.className = 'linus-compliance';
        complianceDiv.style.backgroundColor = '#e8f5e8';
        complianceDiv.style.border = '1px solid #4caf50';
        complianceDiv.style.borderRadius = '4px';
        complianceDiv.style.padding = '1rem';
        complianceDiv.style.margin = '0.5rem 0';
        
        complianceDiv.innerHTML = `
            <h4 style="margin: 0 0 0.5rem 0; color: #2e7d32;">ğŸ”§ LinusåŸå‰‡åˆè¦æ€§</h4>
            <p><strong>æª¢æŸ¥ç‹€æ…‹:</strong> ${compliance.checked ? 'å·²æª¢æŸ¥' : 'æœªæª¢æŸ¥'}</p>
            <p><strong>è©•åˆ†:</strong> ${compliance.score || 'æœªè©•åˆ†'}</p>
            <p><strong>æª¢æŸ¥æ–¹æ³•:</strong> ${compliance.method || 'åŸºæœ¬æª¢æŸ¥'}</p>
        `;
        
        chatMessages.appendChild(complianceDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    // æ¸…é™¤å°è©±
    function clearChat() {
        const chatMessages = document.getElementById('chat-messages');
        chatMessages.innerHTML = `
            <div class="chat-message system">
                <strong>ç³»çµ±:</strong> å°è©±å·²æ¸…é™¤ï¼Œå¯ä»¥é–‹å§‹æ–°çš„å°è©±ã€‚
            </div>
        `;
    }
</script>

<style>
    .chat-message {
        margin-bottom: 1rem;
    }
    
    .chat-message.user {
        text-align: right;
    }
    
    .chat-message.system {
        font-style: italic;
        opacity: 0.8;
    }
    
    #linus-reminder {
        border-left: 4px solid #f39c12;
    }
    
    #linus-reminder ul {
        margin-left: 1rem;
    }
    
    #linus-reminder li {
        margin-bottom: 0.5rem;
    }
</style>
{% endblock %}